language: ruby
dist: bionic
services:
- postgresql
- redis
before_install:
- export APP=check
- export RECORD_RUNTIME=true
- export PATH=/tmp/bundler/ruby/2.4.0/bin:$PATH
- export GEM_PATH=/tmp/bundler/ruby/2.4.0/gems:$GEM_PATH
- export LC_ALL=C.UTF-8
- export LANG=C.UTF-8
- export LANGUAGE=C.UTF-8
- sudo rm -f /etc/apt/sources.list.d/mongodb*
- docker run -d -p 9000:9000 -e "MINIO_ACCESS_KEY=AKIAIOSFODNN7EXAMPLE" -e "MINIO_SECRET_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY" minio/minio server /data
- docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" docker.elastic.co/elasticsearch/elasticsearch:7.9.2
- docker exec elasticsearch elasticsearch-plugin install analysis-icu
- docker restart elasticsearch
- sudo apt-get update
- sudo apt-get install -y libidn11-dev wget phantomjs redis-server graphicsmagick fontconfig libfontconfig ffmpegthumbnailer libtag1-dev golang-go golang-glide
- wget -q --waitretry=5 --retry-connrefused -t 20 -T 10 -O - http://127.0.0.1:9200
- redis-server &
- git clone https://${TOKEN}:x-oauth-basic@github.com/meedan/configurator ./configurator
- mkdir -p ~/.aws && cp configurator/$APP/travis/credentials ~/.aws/
- d=configurator/$APP/travis/check-api/; for f in $(find $d -type f); do cp "$f" "${f/$d/}"; done
- rm -rf tmp/cache tmp/cache1 tmp/cache2 tmp/cache3 tmp/cache4 tmp/cache5 && mkdir -p tmp/cache tmp/cache1
  tmp/cache2 tmp/cache3 tmp/cache4 tmp/cache5
cache:
  directories:
  - "/tmp/bundler"
  - "/tmp/downloads"
  - "/usr/local/lib/python2.7/dist-packages/pip"
addons:
  postgresql: '11'
  hosts:
  - api
bundler_args: "--jobs 3 --retry 3 --without nothing --path=/tmp/bundler"
before_script:
- docker-compose -f docker-test.yml build
- docker-compose -f docker-test.yml up -d
- docker-compose exec api test/setup-parallel-env.sh
- docker-compose exec api bundle exec rake assets:precompile
- sleep 10
- chmod +x job-script-one.sh && chmod +x job-script-two.sh
after_script:
- chmod +x test/test-coverage.sh
- docker-compose exec
  -e TRAVIS_BRANCH=$TRAVIS_BRANCH
  -e GIT_COMMIT_SHA=$GIT_COMMIT_SHA
  -e GIT_COMMITTED_AT=$GIT_COMMITTED_AT
  -e CC_TEST_REPORTER_ID=$CC_TEST_REPORTER_ID
  api test/test-coverage.sh
rvm:
- 2.4
jobs:
  include:
    - stage: test
      script: docker-compose exec api ./job-script-one.sh
    - stage: test
      script: docker-compose exec api ./job-script-two.sh
notifications:
  slack:
    secure: dhqNhrJ0FVPnjtxa7R6k0s+1h/gMFNeK8zYJLZw+mK/FJ41K1u82Y8E6IDFbgNcKyAJ27ielvzGgWGSkDVltEnPR+ph15OMcy05TM9Pr2tWNusbDECOaEQgn4vGOq0shmiahE9tTOQpgc1TzhzIF9o1xgocah2PCLKiiH06kiiRlNZkaeQSJRFrXsPDDK8jIUtkLLUvFGQA6fq/lOh4tN6/N+K6+fo86wSxarkjv3d6h2flqvQqvqkbNpkv/UBC2Y1QACP+EX6uA0ySer8K5X6Q0Trrkjjacwvo5j74UVa+UYrBD+vr7Mgnr5aNFNId6M2nHd92ZiPM+6VDllCWsDLvJ2qFFy8cOO693EjrU7puaPp29+sptriIC71dk1oHSIEpPWwuaEZKzpwP4Swe322ne2th2VrjMhIye2Ru0519Lr2Dl4iTVV+hxoeVta3Nng23rUjrGoAbcw2FO1jmhANp8JWatv/V4PmlrS1/kYbiCfltWOMbKAD9f1EOTFnPCJsp3hPL238Ic+kvNJ8LM+ItNNR5cly+JPto6nSnMO8uhig9i78Mp2hVpnvrwhDLYntWEP2vcaNhP8oRys7X2iq5PRmsRwr9SyJReczd6i5gnvskXqKat6mNfPeGMBKSYof/1ve3Um0wEtwaYxvU5y/ZezFc3Kzzi6vt4P86j+mg=
env:
  global:
    - secure: NwJYV3kghSW2hReSDOnY0sG1oe7IDcix/pZprWHkfkpc+520355n71uj7gofQ2tOO7x2rg2+j9q1GVx9hbP0EsOCIl2u0csnA7lrfe9COp9cGdM7gMzSN6CvuwW9OME9eark37ACSHW1LD1TGB6OcjOkoQxTCM4E00Nj1zAYdT4gbhnBLnxW0FPpEqRB+0XN6ev53HdE5+KrwOIG/chYL/FdaTUdjfyikoduJp5pPjHt1Nd+LSoEt3WbYs8IJeSJIdzCYrD/gXHdjGF1f8v4PFCFyl1ashFtLPMuS+4DBZjR4grSbhpTBwoJAr6oRbWJNAkmaxC26s574U/7QgP6MFlJzhgKim2gvyGUmTSKgxZViyn1y7oend+vWE0281lHDMPqtO3fNel6HteFm/GoJ3lSvZPd8ddveJNacPZB6+K7KzvJWEoRy5eYdUjaejA6KiaSkblpqXoMWwDH+RjCde/HANxMhrECa9yCZlLKBdI5dPccyQwxKnebyZkU37VeWFc9fw2EUy9gmAunV5SH/Osz7b+IX+h3Mf8WxSvQutCUrD+1kspzkEVEXX41SawKD30OfMX9ZBZB9ueisyjB4kW0GzvCGlANMAQ4VDS4/FOmc+5IhcDN8i8PvzE5IGooETOtcwMWVZMrbA0/vq2Z44WQpS2Lq1NYGYhqAN947lk=
